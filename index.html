<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M7939L3V');</script>
    <!-- End Google Tag Manager -->

    <title>Google Maps - Building Viewer</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCobCO1jQNA8cIv-IwQU9uzR9qoQaqvFiY&libraries=drawing"></script>
    
    <!-- Google Fonts for Modern Typography -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">

    <style>
        /* General Styles for Modern Look */
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }

        #map {
            filter: grayscale(10%) brightness(95%);
        }

        .settings-button {
            position: absolute;
            top: 60px;
            right: 5px;
            background: url('https://shuaibfarouk.github.io/AlMutlaa/images/settings.png') no-repeat center;
            background-size: contain;
            width: 40px;
            height: 40px;
            cursor: pointer;
            filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.2));
        }

        .menu {
            position: absolute;
            top: 80px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            z-index: 1000;
            width: 250px;
            font-size: 14px;
            display: none;
            transition: all 0.3s ease;
        }

        .menu input[type="text"], .menu select {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .menu button {
            background-color: #007BFF;
            color: white;
            padding: 6px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 14px;
            margin-top: 8px;
        }

        .menu button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .menu button:active {
            background-color: #003d80;
            transform: translateY(1px);
        }

        .search-section {
            margin-top: 8px;
            border-top: 1px solid #ddd;
            padding-top: 8px;
        }

        .autocomplete {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background-color: #fff;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        .selected-item {
            background-color: #e9ecef;
            padding: 4px;
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            border-radius: 4px;
        }

        .color-picker {
            margin-left: 10px;
            padding: 0;
            border: none;
            cursor: pointer;
            width: 20px;
            height: 20px;
        }

        .remove-item {
            cursor: pointer;
            color: red;
            margin-left: 10px;
        }

        .info-window {
            max-width: 350px;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: #333;
            background-color: #ffffff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .info-window table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-window th, .info-window td {
            border: 1px solid #ddd;
            padding: 6px 10px;
            text-align: left;
            font-size: 13px;
        }

        .info-window th {
            background-color: #f8f9fa;
            font-weight: 700;
        }

        .gm-ui-hover-effect {
            width: 20px;
            height: 20px;
        }

        #revision {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #dc3545;
            font-weight: bold;
        }

        #building-count {
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .custom-info-window {
            background-color: rgba(0, 123, 255, 0.9);
            color: #FFFFFF;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            transition: all 0.3s ease;
            width: 100px;
            text-align: center;
            line-height: 1.2;
            position: absolute;
            z-index: 1000;
        }

        .custom-info-window.zoomed-out {
            font-size: 8px;
            padding: 2px 4px;
            width: 80px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
        }

        .checkbox-container input[type="checkbox"] {
            transform: scale(0.8);
            margin-right: 5px;
        }
    </style>
</head>
<body onload="initMap()">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M7939L3V"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div id="map"></div>

    <!-- Settings Button -->
    <div class="settings-button" onclick="toggleMenu()"></div>

    <!-- Menu Section -->
    <div id="menu" class="menu">
        <div class="search-section">
            <div class="autocomplete">
                <input id="buildingSearch" type="text" placeholder="Enter Building Type">
            </div>
            <button onclick="addItem('building')">Add</button>
        </div>
        <div id="selectedBuildings"></div>
        
        <div class="search-section">
            <div class="autocomplete">
                <input id="pkgTenConSearch" type="text" placeholder="Enter Package/Tender/Contract">
            </div>
            <button onclick="addItem('pkgTenCon')">Add</button>
        </div>
        <div id="selectedPkgTenCon"></div>

        <div class="search-section">
            <select id="buildingStatusSelect">
                <option value="">Select Building Status</option>
            </select>
            <button onclick="addBuildingStatus()">Add</button>
            <div id="selectedBuildingStatuses"></div>
        </div>

        <div class="search-section">
            <select id="buildingOperationalStatusSelect">
                <option value="">Select Building Operational Status</option>
            </select>
            <button onclick="addBuildingOperationalStatus()">Add</button>
            <div id="selectedBuildingOperationalStatuses"></div>

        </div>

        <div class="search-section">
            <select id="fiscalYearTenderSelect">
                <option value="">Select Fiscal Year Tender</option>
            </select>
            <button onclick="addFiscalYearTender()">Add</button>
            <div id="selectedFiscalYearTenders"></div>
        </div>

        <div class="search-section">
            <select id="colorCriteriaSelect" onchange="handleColorCriteriaChange()">
                <option value="">Select Criteria for Coloring</option>
                <option value="building">Building Type</option>
                <option value="pkgTenCon">Package/Tender/Contract</option>
                <option value="status">Building Status</option>
                <option value="operational">Operational Status</option>
                <option value="fiscal">Fiscal Year</option>
            </select>
        </div>

        <div class="search-section checkbox-container">
            <input type="checkbox" id="tagSearchedBuilding" onchange="toggleTagInfoWindow()"/>
            <label for="tagSearchedBuilding">Tag searched building / Plot</label>
        </div>

        <button onclick="combinedSearch()">Search</button>
        <button onclick="clearSearch()">Clear</button>
        <div id="building-count"></div>
    </div>
    <div id="revision">Status as of: 30 July 2024</div>

    <!-- Text Resize and Label Toggle Buttons -->
    <div id="textResizeButtons" style="position: absolute; top: 10px; right: 60px;">
        <button onclick="resizeText(1)">A+</button>
        <span id="textSizeDisplay">11</span>
        <button onclick="resizeText(-1)">A-</button>
    </div>
    <button id="toggleLabels" onclick="toggleBuildingLabels()" style="position: absolute; top: 10px; right: 150px;">
        Show Labels
    </button>

    <script>
        let map;
        let jsonData = {};
        let polygons = [];
        let buildingTypes = new Set();
        let buildingStatuses = new Set();
        let buildingOperationalStatuses = new Set();
        let fiscalYearTenders = new Set();
        let selectedBuildings = [];
        let selectedPkgTenCon = [];
        let selectedBuildingStatuses = [];
        let selectedBuildingOperationalStatuses = [];
        let selectedFiscalYearTenders = [];
        let filteredData = [];
        let colorMapping = {};
        let customInfoWindows = [];
        let currentZoom;
        let baseTextSize = 11;
        let labelsVisible = false; // Initially, labels are hidden

        // Throttle function for zoom event
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 29.478324, lng: 47.607149 },
                zoom: 12,
                mapTypeId: 'roadmap',
                styles: [
                    {
                        "elementType": "geometry",
                        "stylers": [{ "color": "#ebe3cd" }]
                    },
                    {
                        "elementType": "labels.text.fill",
                        "stylers": [{ "color": "#523735" }]
                    },
                    {
                        "elementType": "labels.text.stroke",
                        "stylers": [{ "color": "#f5f5f5" }]
                    },
                    {
                        "featureType": "administrative",
                        "elementType": "geometry.stroke",
                        "stylers": [{ "color": "#c9b2a6" }]
                    },
                    {
                        "featureType": "landscape.man_made",
                        "elementType": "geometry.stroke",
                        "stylers": [{ "color": "#dcd2be" }]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry",
                        "stylers": [{ "color": "#f5f1e6" }]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry.fill",
                        "stylers": [{ "color": "#blue" }]
                    }
                ]
            });

            // Use throttling for the zoom_changed listener
            map.addListener('zoom_changed', throttle(function() {
                if (labelsVisible) {
                    updateLabelSize();
                    updateInfoWindowsScale();
                }
            }, 100));

            map.addListener('bounds_changed', throttle(function() {
                if (labelsVisible) {
                    loadVisibleLabels();
                }
            }, 100));

            loadJSONData();
            loadKML();
        }

        function loadJSONData() {
            fetch('https://shuaibfarouk.github.io/AlMutlaa/components%20data.json')
                .then(response => response.json())
                .then(data => {
                    jsonData = data;
                    filteredData = data;
                    data.forEach(item => {
                        if (item["Building Type"]) buildingTypes.add(item["Building Type"]);
                        if (item["Status Building"]) buildingStatuses.add(item["Status Building"]);
                        if (item["Building Operational Status"]) buildingOperationalStatuses.add(item["Building Operational Status"]);
                        if (item["Fiscal Year Based on Tender"]) fiscalYearTenders.add(item["Fiscal Year Based on Tender"]);
                    });
                    populateAutocompleteAndDropdowns();
                })
                .catch(error => console.error('Error loading JSON data:', error));
        }

        function loadKML() {
            const kmlUrl = 'https://shuaibfarouk.github.io/AlMutlaa/al%20mutlaa%20KML.kml';
            
            fetch(kmlUrl)
                .then(response => response.text())
                .then(kmlData => {
                    const parser = new DOMParser();
                    const kmlDoc = parser.parseFromString(kmlData, 'text/xml');
                    const placemarks = kmlDoc.getElementsByTagName('Placemark');

                    for (let placemark of placemarks) {
                        const coordinates = placemark.getElementsByTagName('coordinates')[0].textContent.trim().split(' ');
                        const path = coordinates.map(coord => {
                            const [lng, lat] = coord.split(',');
                            return {lat: parseFloat(lat), lng: parseFloat(lng)};
                        });

                        const polygon = new google.maps.Polygon({
                            paths: path,
                            strokeColor: '#00aaff',
                            strokeOpacity: 1,
                            strokeWeight: 2,
                            fillColor: '#00aaff',
                            fillOpacity: 0.5,
                            map: map
                        });

                        const componentId = getComponentId(placemark);
                        polygon.componentId = componentId;
                        polygons.push(polygon);
                        
                        polygon.addListener('click', function(event) {
                            handlePolygonClick(event, componentId);
                        });
                    }
                    addGetBoundsToPolygon();
                })
                .catch(error => console.error('Error loading KML:', error));
        }

        function addGetBoundsToPolygon() {
            google.maps.Polygon.prototype.getBounds = function() {
                var bounds = new google.maps.LatLngBounds();
                this.getPath().forEach(function(element) {
                    bounds.extend(element);
                });
                return bounds;
            };
        }

        function getComponentId(placemark) {
            const simpleDataElements = placemark.getElementsByTagName('SimpleData');
            for (let element of simpleDataElements) {
                if (element.getAttribute('name') === 'Component ID') {
                    return element.textContent;
                }
            }
            return null;
        }

        function handlePolygonClick(event, componentId) {
            if (componentId) {
                const matchingData = jsonData.find(item => item["Component ID"] == componentId);

                if (matchingData) {
                    const content = `
                        <div class="info-window">
                            <table>
                                <tr>
                                    <th colspan="2">${matchingData["Building Type"] || 'N/A'}</th>
                                    <th>${matchingData["Neighborhood"] || 'N/A'}</th>
                                    <th>Block ${matchingData["Block"] || 'N/A'}</th>
                                </tr>
                                <tr>
                                    <th colspan="4">${matchingData["Package-Tender-Contract"] || 'N/A'}</th>
                                </tr>
                                <tr>
                                    <td>Tender / Contract Status</td>
                                    <td colspan="3">${matchingData["Status Package"] || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Building Status</td>
                                    <td colspan="3">${matchingData["Status Building"] || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Tender:</td>
                                    <td colspan="3">${matchingData["Fiscal Year Based on Tender"] || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Tender Date:</td>
                                    <td colspan="3">${matchingData["Tender Announcement Date"] || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Construction Start Date:</td>
                                    <td colspan="3">${matchingData["Construction Start Date"] || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Construction End Date:</td>
                                    <td colspan="3">${matchingData["Construction End Date"] || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Building Operational Status:</td>
                                    <td colspan="3">${matchingData["Building Operational Status"] || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Handing Over Date:</td>
                                    <td colspan="3">${matchingData["Handing Over to End User - Date"] || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Operational Start Date:</td>
                                    <td colspan="3">${matchingData["Operation Start Date"] || 'N/A'}</td>
                                </tr>
                            </table>
                        </div>
                    `;

                    const infowindow = new google.maps.InfoWindow({
                        content: content,
                        position: event.latLng,
                        maxWidth: 350
                    });

                    infowindow.open(map);
                }
            }
        }

        function loadVisibleLabels() {
            const bounds = map.getBounds();
            polygons.forEach(polygon => {
                if (!polygon.getBounds) return; // Skip if getBounds is not defined
                
                const matchingData = jsonData.find(item => item["Component ID"] == polygon.componentId);
                if (matchingData && bounds.intersects(polygon.getBounds())) {
                    const center = polygon.getBounds().getCenter();
                    if (!center) return; // Skip if we can't get a valid center
                    
                    if (!polygon.label) {
                        const label = new google.maps.Marker({
                            position: center,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 0,
                            },
                            label: {
                                text: matchingData["Building Type"] || '',
                                color: "black",
                                fontSize: baseTextSize + "px",
                            },
                        });
                        polygon.label = label;
                    } else {
                        polygon.label.setPosition(center);
                        polygon.label.setMap(map);
                    }
                } else if (polygon.label) {
                    polygon.label.setMap(null);
                }
            });
        }

        function toggleMenu() {
            const menu = document.getElementById('menu');
            menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
        }

        function addItem(type) {
            let inputElement, selectedArray, selectedDiv, placeholderText;
            switch (type) {
                case 'building':
                    inputElement = document.getElementById('buildingSearch');
                    selectedArray = selectedBuildings;
                    selectedDiv = document.getElementById('selectedBuildings');
                    placeholderText = 'Enter Building Type';
                    break;
                case 'pkgTenCon':
                    inputElement = document.getElementById('pkgTenConSearch');
                    selectedArray = selectedPkgTenCon;
                    selectedDiv = document.getElementById('selectedPkgTenCon');
                    placeholderText = 'Enter Package/Tender/Contract';
                    break;
            }

            const inputValue = inputElement.value.trim();
            if (inputValue && !selectedArray.includes(inputValue)) {
                selectedArray.push(inputValue);
                const newItem = document.createElement('div');
                newItem.classList.add('selected-item');
                newItem.textContent = inputValue;
                const removeIcon = document.createElement('span');
                removeIcon.textContent = 'x';
                removeIcon.classList.add('remove-item');
                removeIcon.onclick = function() {
                    selectedArray.splice(selectedArray.indexOf(inputValue), 1);
                    selectedDiv.removeChild(newItem);
                };
                newItem.appendChild(removeIcon);
                selectedDiv.appendChild(newItem);
            }
            inputElement.value = '';
            inputElement.setAttribute('placeholder', placeholderText);
        }

        function addBuildingStatus() {
            addDropdownSelection('buildingStatusSelect', selectedBuildingStatuses, 'selectedBuildingStatuses');
        }

        function addBuildingOperationalStatus() {
            addDropdownSelection('buildingOperationalStatusSelect', selectedBuildingOperationalStatuses, 'selectedBuildingOperationalStatuses');
        }

        function addFiscalYearTender() {
            addDropdownSelection('fiscalYearTenderSelect', selectedFiscalYearTenders, 'selectedFiscalYearTenders');
        }

        function addDropdownSelection(selectId, selectedArray, selectedDivId) {
            const selectElement = document.getElementById(selectId);
            const selectedValue = selectElement.value;
            if (selectedValue && !selectedArray.includes(selectedValue)) {
                selectedArray.push(selectedValue);
                const newItem = document.createElement('div');
                newItem.classList.add('selected-item');
                newItem.textContent = selectedValue;
                const removeIcon = document.createElement('span');
                removeIcon.textContent = 'x';
                removeIcon.classList.add('remove-item');
                removeIcon.onclick = function() {
                    selectedArray.splice(selectedArray.indexOf(selectedValue), 1);
                    document.getElementById(selectedDivId).removeChild(newItem);
                };
                newItem.appendChild(removeIcon);
                document.getElementById(selectedDivId).appendChild(newItem);
            }
        }

        function combinedSearch() {
            updateFilteredData();
            displayTagInfoWindow();
        }

        function clearSearch() {
            selectedBuildings = [];
            selectedPkgTenCon = [];
            selectedBuildingStatuses = [];
            selectedBuildingOperationalStatuses = [];
            selectedFiscalYearTenders = [];
            filteredData = jsonData;

            document.getElementById('selectedBuildings').innerHTML = '';
            document.getElementById('selectedPkgTenCon').innerHTML = '';
            document.getElementById('selectedBuildingStatuses').innerHTML = '';
            document.getElementById('selectedBuildingOperationalStatuses').innerHTML = '';
            document.getElementById('selectedFiscalYearTenders').innerHTML = '';

            closeAllTagInfoWindows();
            document.getElementById('tagSearchedBuilding').checked = false;
            updateBuildingCount();
            map.setCenter({ lat: 29.478324, lng: 47.607149 });
            map.setZoom(12);
        }

        function updateFilteredData() {
            filteredData = jsonData.filter(item => {
                let matchesBuildingType = selectedBuildings.length === 0 || selectedBuildings.includes(item["Building Type"]);
                let matchesBuildingStatus = selectedBuildingStatuses.length === 0 || selectedBuildingStatuses.includes(item["Status Building"]);
                let matchesPkgTenCon = selectedPkgTenCon.length === 0 || selectedPkgTenCon.includes(item["Package-Tender-Contract"]);
                let matchesOperationalStatus = selectedBuildingOperationalStatuses.length === 0 || selectedBuildingOperationalStatuses.includes(item["Building Operational Status"]);
                let matchesFiscalYear = selectedFiscalYearTenders.length === 0 || selectedFiscalYearTenders.includes(item["Fiscal Year Based on Tender"]);

                return matchesBuildingType && matchesBuildingStatus && matchesPkgTenCon && matchesOperationalStatus && matchesFiscalYear;
            });

            applyUnifiedColors();
            updateBuildingCount();
            displayTagInfoWindows();
        }

        function populateAutocompleteAndDropdowns() {
            const dataToUse = filteredData.length < jsonData.length ? jsonData : filteredData;

            const buildingTypes = Array.from(new Set(dataToUse.map(item => item["Building Type"]).filter(Boolean)));
            const packageTenderContracts = Array.from(new Set(dataToUse.map(item => item["Package-Tender-Contract"]).filter(Boolean)));

            autocomplete(document.getElementById("buildingSearch"), buildingTypes);
            autocomplete(document.getElementById("pkgTenConSearch"), packageTenderContracts);

            populateSelect(document.getElementById('buildingStatusSelect'), new Set(dataToUse.map(item => item["Status Building"]).filter(Boolean)), "Select Building Status");
            populateSelect(document.getElementById('buildingOperationalStatusSelect'), new Set(dataToUse.map(item => item["Building Operational Status"]).filter(Boolean)), "Select Building Operational Status");
            populateSelect(document.getElementById('fiscalYearTenderSelect'), new Set(dataToUse.map(item => item["Fiscal Year Based on Tender"]).filter(Boolean)), "Select Fiscal Year Tender");
        }

        function autocomplete(inp, arr) {
            var currentFocus;
            inp.addEventListener("input", function(e) {
                var a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false;}
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                for (i = 0; i < arr.length; i++) {
                    if (arr[i].toUpperCase().includes(val.toUpperCase())) {
                        b = document.createElement("DIV");
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            inp.addEventListener("keydown", function(e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) {
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) {
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });
            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(x) {
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        function populateSelect(selectElement, items, placeholder) {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.text = item;
                selectElement.appendChild(option);
            });
        }

        function applyUnifiedColors() {
            polygons.forEach(polygon => {
                const matchingData = filteredData.find(item => item["Component ID"] == polygon.componentId);
                if (matchingData) {
                    const colorCriteria = document.getElementById('colorCriteriaSelect').value;
                    let color = '#00aaff'; // Default color
                    
                    switch (colorCriteria) {
                        case 'building':
                            color = colorMapping[matchingData["Building Type"]] || '#00aaff';
                            break;
                        case 'pkgTenCon':
                            color = colorMapping[matchingData["Package-Tender-Contract"]] || '#00aaff';
                            break;
                        case 'status':
                            color = colorMapping[matchingData["Status Building"]] || '#00aaff';
                            break;
                        case 'operational':
                            color = colorMapping[matchingData["Building Operational Status"]] || '#00aaff';
                            break;
                        case 'fiscal':
                            color = colorMapping[matchingData["Fiscal Year Based on Tender"]] || '#00aaff';
                            break;
                    }

                    polygon.setOptions({fillColor: color, strokeColor: color});

                    if (polygon.label) {
                        polygon.label.setLabel({
                            text: polygon.label.getLabel().text,
                            color: color === matchedColor ? "black" : "darkgray",
                            fontSize: polygon.label.getLabel().fontSize
                        });
                    }
                }
            });
        }

        function handleColorCriteriaChange() {
            applyUnifiedColors();
        }

        function toggleTagInfoWindow() {
            displayTagInfoWindows();
        }

        function displayTagInfoWindows() {
            const tagCheckbox = document.getElementById('tagSearchedBuilding');
            const hasActiveSearchCriteria = selectedBuildings.length > 0 || 
                                            selectedPkgTenCon.length > 0 || 
                                            selectedBuildingStatuses.length > 0 || 
                                            selectedBuildingOperationalStatuses.length > 0 || 
                                            selectedFiscalYearTenders.length > 0;

            closeAllTagInfoWindows();

            if (tagCheckbox.checked && hasActiveSearchCriteria && filteredData.length > 0) {
                filteredData.forEach(item => {
                    const matchingPolygon = polygons.find(polygon => polygon.componentId === item["Component ID"]);
                    if (matchingPolygon) {
                        const bounds = new google.maps.LatLngBounds();
                        matchingPolygon.getPath().forEach(function(element) {
                            bounds.extend(element);
                        });

                        const center = bounds.getCenter();
                        const customInfoWindow = new CustomInfoWindow(center, item);
                        customInfoWindow.setMap(map);
                        customInfoWindows.push(customInfoWindow);
                    }
                });
                updateInfoWindowsScale();
            }
        }

        class CustomInfoWindow extends google.maps.OverlayView {
            constructor(position, data) {
                super();
                this.position = position;
                this.data = data;
                this.div = null;
            }

            onAdd() {
                this.div = document.createElement('div');
                this.div.className = 'custom-info-window';
                this.div.innerHTML = this.getContent();
                this.getPanes().overlayMouseTarget.appendChild(this.div);
            }

            draw() {
                const overlayProjection = this.getProjection();
                const position = overlayProjection.fromLatLngToDivPixel(this.position);
                
                if (this.div) {
                    this.div.style.left = (position.x - 50) + 'px';
                    this.div.style.top = (position.y - 25) + 'px';
                    this.div.style.position = 'absolute';
                    this.div.style.visibility = 'visible';
                }
            }

            onRemove() {
                if (this.div) {
                    this.div.parentNode.removeChild(this.div);
                    this.div = null;
                }
            }

            getContent() {
                return `
                    <strong>${this.data["Building Type"] || 'N/A'}</strong><br>
                    ${this.data["Package-Tender-Contract"] || 'N/A'}<br>
                    ${this.data["Status Building"] || 'N/A'}
                `;
            }
        }

        function updateLabelSize() {
            const zoom = map.getZoom();
            const fontSize = Math.max(8, Math.min(16, baseTextSize + zoom - 12)) + "px";
            polygons.forEach(polygon => {
                if (polygon.label) {
                    const currentLabel = polygon.label.getLabel();
                    polygon.label.setLabel({...currentLabel, fontSize: fontSize});
                }
            });
        }

        function closeAllTagInfoWindows() {
            customInfoWindows.forEach(infoWindow => {
                infoWindow.setMap(null);
            });
            customInfoWindows = [];
        }

        function toggleBuildingLabels() {
            labelsVisible = !labelsVisible;
            polygons.forEach(polygon => {
                if (polygon.label) {
                    if (labelsVisible) {
                        polygon.label.setMap(map);
                        updateLabelSize(); // Ensure correct size when showing
                    } else {
                        polygon.label.setMap(null);
                    }
                }
            });
            document.getElementById('toggleLabels').innerText = labelsVisible ? 'Hide Labels' : 'Show Labels';
        }

        function resizeText(change) {
            baseTextSize = Math.max(8, Math.min(16, baseTextSize + change));
            document.getElementById('textSizeDisplay').innerText = baseTextSize;
            updateLabelSize();
        }

        function updateBuildingCount() {
            const countElement = document.getElementById('building-count');
            countElement.textContent = `Buildings Found: ${filteredData.length}`;
        }
    </script>
</body>
</html>
