<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M7939L3V');</script>
    <!-- End Google Tag Manager -->
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Website Title</title>
    <style>
        /* Add any additional styles here */
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M7939L3V"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div id="map" style="height: 100vh;"></div>

    <div class="settings-button" onclick="toggleMenu()">⚙️</div>

    <div id="menu" class="menu">
        <div class="search-section">
            <input id="buildingSearch" type="text" placeholder="Enter Building Type">
            <button onclick="addItem('building')">Add</button>
            <div id="selectedBuildings"></div>
        </div>

        <div class="search-section">
            <input id="pkgTenConSearch" type="text" placeholder="Enter Package/Tender/Contract">
            <button onclick="addItem('pkgTenCon')">Add</button>
            <div id="selectedPkgTenCon"></div>
        </div>

        <div class="search-section">
            <select id="buildingStatusSelect">
                <option value="">Select Building Status</option>
            </select>
            <button onclick="addBuildingStatus()">Add</button>
            <div id="selectedBuildingStatuses"></div>
        </div>

        <div class="search-section">
            <select id="buildingOperationalStatusSelect">
                <option value="">Select Building Operational Status</option>
            </select>
            <button onclick="addBuildingOperationalStatus()">Add</button>
            <div id="selectedBuildingOperationalStatuses"></div>
        </div>

        <div class="search-section">
            <select id="fiscalYearTenderSelect">
                <option value="">Select Fiscal Year Tender</option>
            </select>
            <button onclick="addFiscalYearTender()">Add</button>
            <div id="selectedFiscalYearTenders"></div>
        </div>

        <div class="search-section">
            <select id="colorCriteriaSelect" onchange="handleColorCriteriaChange()">
                <option value="building">Building Type</option>
                <option value="pkgTenCon">Package/Tender/Contract</option>
                <option value="status">Building Status</option>
                <option value="operational">Operational Status</option>
                <option value="fiscal">Fiscal Year</option>
            </select>
        </div>

        <div class="search-section checkbox-container">
            <input type="checkbox" id="tagSearchedBuilding" onclick="toggleTagInfoWindow()"> Tag searched building / Plot
        </div>

        <button onclick="combinedSearch()">Search</button>
        <button onclick="clearSearch()">Clear</button>

        <div id="building-count"></div>
    </div>

    <div id="revision">
        Status as of: 30 July 2024
    </div>

    <div id="textResizeButtons" style="position: absolute; top: 10px; right: 60px;">
        <button onclick="resizeText(1)">A+</button>
        <span id="textSizeDisplay">11</span>
        <button onclick="resizeText(-1)">A-</button>
    </div>

    <button id="toggleLabels" onclick="toggleBuildingLabels()">Show Labels</button>

    <script>
        // JavaScript functions and logic go here
        
        let map;
        let jsonData = {};
        let polygons = [];
        let buildingTypes = new Set();
        let buildingStatuses = new Set();
        let buildingOperationalStatuses = new Set();
        let fiscalYearTenders = new Set();
        let selectedBuildings = [];
        let selectedPkgTenCon = [];
        let selectedBuildingStatuses = [];
        let selectedBuildingOperationalStatuses = [];
        let selectedFiscalYearTenders = [];
        let filteredData = [];
        let baseTextSize = 11;
        let labelsVisible = true;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 29.478324, lng: 47.607149 },
                zoom: 12,
                mapTypeId: 'roadmap',
                styles: [
                    // ... (map styles remain the same) ...
                ]
            });

            map.addListener('zoom_changed', throttle(function() {
                updateLabelSize();
                updateInfoWindowsScale();
            }, 100));

            loadJSONData();
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        function loadJSONData() {
            fetch('https://shuaibfarouk.github.io/AlMutlaa/components%20data.json')
                .then(response => response.json())
                .then(data => {
                    jsonData = data;
                    filteredData = data;
                    data.forEach(item => {
                        if (item["Building Type"]) buildingTypes.add(item["Building Type"]);
                        if (item["Status Building"]) buildingStatuses.add(item["Status Building"]);
                        if (item["Building Operational Status"]) buildingOperationalStatuses.add(item["Building Operational Status"]);
                        if (item["Fiscal Year Based on Tender"]) fiscalYearTenders.add(item["Fiscal Year Based on Tender"]);
                    });
                    populateAutocompleteAndDropdowns();
                })
                .catch(error => console.error('Error loading JSON data:', error));
        }

        function autocomplete(inp, arr) {
            var currentFocus;
            inp.addEventListener("input", function(e) {
                var a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false;}
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                for (i = 0; i < arr.length; i++) {
                    if (arr[i].toUpperCase().includes(val.toUpperCase())) {
                        b = document.createElement("DIV");
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            inp.addEventListener("keydown", function(e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) {
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) {
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });
            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(x) {
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        function populateAutocompleteAndDropdowns() {
            const dataToUse = filteredData.length < jsonData.length ? jsonData : filteredData;

            const buildingTypes = Array.from(new Set(dataToUse.map(item => item["Building Type"]).filter(Boolean)));
            const packageTenderContracts = Array.from(new Set(dataToUse.map(item => item["Package-Tender-Contract"]).filter(Boolean)));

            autocomplete(document.getElementById("buildingSearch"), buildingTypes);
            autocomplete(document.getElementById("pkgTenConSearch"), packageTenderContracts);

            populateSelect(document.getElementById('buildingStatusSelect'), new Set(dataToUse.map(item => item["Status Building"]).filter(Boolean)), "Select Building Status");
            populateSelect(document.getElementById('buildingOperationalStatusSelect'), new Set(dataToUse.map(item => item["Building Operational Status"]).filter(Boolean)), "Select Building Operational Status");
            populateSelect(document.getElementById('fiscalYearTenderSelect'), new Set(dataToUse.map(item => item["Fiscal Year Based on Tender"]).filter(Boolean)), "Select Fiscal Year Tender");
        }

        function populateSelect(selectElement, optionsSet, defaultOption) {
            selectElement.innerHTML = `<option value="">${defaultOption}</option>`;
            optionsSet.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.text = option;
                selectElement.appendChild(opt);
            });
        }

        function addItem(type) {
            let inputId, selectedArray, divId;
            if (type === 'building') {
                inputId = 'buildingSearch';
                selectedArray = selectedBuildings;
                divId = 'selectedBuildings';
            } else if (type === 'pkgTenCon') {
                inputId = 'pkgTenConSearch';
                selectedArray = selectedPkgTenCon;
                divId = 'selectedPkgTenCon';
            }
            const value = document.getElementById(inputId).value;
            if (value && !selectedArray.includes(value)) {
                selectedArray.push(value);
                updateSelectedItemsDisplay(divId, selectedArray, type);
            }
            combinedSearch();
        }

        function addBuildingStatus() {
            const value = document.getElementById('buildingStatusSelect').value;
            if (value && !selectedBuildingStatuses.includes(value)) {
                selectedBuildingStatuses.push(value);
                updateSelectedItemsDisplay('selectedBuildingStatuses', selectedBuildingStatuses, 'status');
            }
            combinedSearch();
        }

        function addBuildingOperationalStatus() {
            const value = document.getElementById('buildingOperationalStatusSelect').value;
            if (value && !selectedBuildingOperationalStatuses.includes(value)) {
                selectedBuildingOperationalStatuses.push(value);
                updateSelectedItemsDisplay('selectedBuildingOperationalStatuses', selectedBuildingOperationalStatuses, 'operational');
            }
            combinedSearch();
        }

        function addFiscalYearTender() {
            const value = document.getElementById('fiscalYearTenderSelect').value;
            if (value && !selectedFiscalYearTenders.includes(value)) {
                selectedFiscalYearTenders.push(value);
                updateSelectedItemsDisplay('selectedFiscalYearTenders', selectedFiscalYearTenders, 'fiscal');
            }
            combinedSearch();
        }

        function updateSelectedItemsDisplay(divId, selectedArray, type) {
            const div = document.getElementById(divId);
            div.innerHTML = '';
            selectedArray.forEach(item => {
                const span = document.createElement('span');
                span.classList.add('selected-item');
                span.textContent = item;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.onclick = function() {
                    selectedArray.splice(selectedArray.indexOf(item), 1);
                    updateSelectedItemsDisplay(divId, selectedArray, type);
                    combinedSearch();
                };
                span.appendChild(removeBtn);
                div.appendChild(span);
            });
        }

        function combinedSearch() {
            filteredData = jsonData.filter(item => {
                const matchesBuildingType = selectedBuildings.length === 0 || selectedBuildings.includes(item["Building Type"]);
                const matchesPkgTenCon = selectedPkgTenCon.length === 0 || selectedPkgTenCon.includes(item["Package-Tender-Contract"]);
                const matchesStatus = selectedBuildingStatuses.length === 0 || selectedBuildingStatuses.includes(item["Status Building"]);
                const matchesOperational = selectedBuildingOperationalStatuses.length === 0 || selectedBuildingOperationalStatuses.includes(item["Building Operational Status"]);
                const matchesFiscal = selectedFiscalYearTenders.length === 0 || selectedFiscalYearTenders.includes(item["Fiscal Year Based on Tender"]);

                return matchesBuildingType && matchesPkgTenCon && matchesStatus && matchesOperational && matchesFiscal;
            });
            updateMap();
            updateBuildingCount();
        }

        function updateMap() {
            // Functionality to update map with filtered data goes here.
        }

        function updateBuildingCount() {
            const countDiv = document.getElementById('building-count');
            countDiv.textContent = `Showing ${filteredData.length} buildings/plots`;
        }

        function handleColorCriteriaChange() {
            // Functionality to handle color criteria change goes here.
        }

        function resizeText(change) {
            baseTextSize = Math.max(8, Math.min(16, baseTextSize + change));
            document.getElementById('textSizeDisplay').innerText = baseTextSize;
            updateLabelSize();
        }

        function updateLabelSize() {
            const zoom = map.getZoom();
            const fontSize = Math.max(8, Math.min(16, baseTextSize + zoom - 12)) + "px";
            polygons.forEach(polygon => {
                if (polygon.label) {
                    const currentLabel = polygon.label.getLabel();
                    polygon.label.setLabel({...currentLabel, fontSize: fontSize});
                }
            });
        }

        function toggleBuildingLabels() {
            labelsVisible = !labelsVisible;
            polygons.forEach(polygon => {
                if (polygon.label) {
                    if (labelsVisible) {
                        polygon.label.setMap(map);
                        updateLabelSize(); // Ensure correct size when showing
                    } else {
                        polygon.label.setMap(null);
                    }
                }
            });
            document.getElementById('toggleLabels').innerText = labelsVisible ? 'Hide Labels' : 'Show Labels';
        }

        function clearSearch() {
            selectedBuildings = [];
            selectedPkgTenCon = [];
            selectedBuildingStatuses = [];
            selectedBuildingOperationalStatuses = [];
            selectedFiscalYearTenders = [];
            document.getElementById('selectedBuildings').innerHTML = '';
            document.getElementById('selectedPkgTenCon').innerHTML = '';
            document.getElementById('selectedBuildingStatuses').innerHTML = '';
            document.getElementById('selectedBuildingOperationalStatuses').innerHTML = '';
            document.getElementById('selectedFiscalYearTenders').innerHTML = '';
            filteredData = jsonData;
            updateMap();
            updateBuildingCount();
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCobCO1jQNA8cIv-IwQU9uzR9qoQaqvFiY&callback=initMap">
    </script>
</body>
</html>
